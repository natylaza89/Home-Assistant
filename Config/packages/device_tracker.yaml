###############################################################################
#   @author         :   Naty Laza
#   @date           :   28/10/2018
#   @package        :   Device Tracker
#   @description    :   Device Tracker Via TrackR ,Bluetooth, WiFi etc.
#                       Configuration Of Zones, Current Status, Notifying
#                       Refresh Status.
###############################################################################

####################################################
#                   HA Location                    #
####################################################

homeassistant:
  latitude: !secret homeassistant_latitude
  longitude: !secret homeassistant_longitude
  elevation: !secret homeassistant_elevation

####################################################
#                   Customize                      #
####################################################

homeassistant:
  customize_domain:
    automation:
      initial_state: 'on'
  
  customize:
      
     automation.naty_is_home:
      icon: mdi:map-marker
     automation.naty_leave_home:
      icon: mdi:map-marker
     automation.naty_is_at_college:
      icon: mdi:school
     automation.naty_leave_college:
      icon: mdi:school
     automation.naty_arrived_ashkelon:
      icon: mdi:home-heart

     automation.nofar_is_home:
      icon: mdi:account-supervisor-circle
     automation.nofar_left_home:
      icon: mdi:account-supervisor
     automation.nofar_is_at_college:
      icon: mdi:school
     automation.nofar_leave_college:
      icon: mdi:school
     automation.nofar_is_at_work:
      icon: mdi:briefcase
     automation.nofar_left_work:
      icon: mdi:briefcase
     automation.nofar_arrived_natanya:
      icon: mdi:home-heart

####################################################
#                    Device Tracker                #
####################################################

device_tracker:
  - platform: trackr
    username: !secret trackr_user
    password: !secret trackr_password
  
  #- platform: owntracks
    #max_gps_accuracy: 50
    #waypoints: True
    #mqtt_topic: !secret mqtt_topic
  
 #- platform: bluetooth_le_tracker
 
  - platform: bluetooth_tracker
    interval_seconds: 15
    consider_home: 15
    track_new_devices: false

####################################################
#                     Zones                        #
####################################################
zone:
  - name: Ashkelon
    latitude: !secret Ashkelon_latitude
    longitude: !secret Ashkelon_longitude
    icon: mdi:home-map-marker
    radius: 350
   
  - name: Natanya
    latitude: !secret Natanya_latitude
    longitude: !secret Natanya_longitude
    icon: mdi:home
    radius: 350
   
  - name: College
    latitude: !secret College_latitude
    longitude: !secret College_longitude
    icon: mdi:school
    radius: 250
    
  - name: Home
    latitude: !secret Home_latitude
    longitude: !secret Home_longitude
    icon: mdi:home
    radius: 40
    
  - name: Nofar Work
    latitude: !secret Nofar_Work_latitude
    longitude: !secret Nofar_Work_longitude
    icon: mdi:home
    radius: 500
    
  - name: Hazi Hinam
    latitude: !secret Hazi_Hinam_latitude
    longitude: !secret Hazi_Hinam_longitude
    icon: mdi:cart
    radius: 50
    
  - name: Shufersal
    latitude: !secret Shufersal_latitude
    longitude: !secret Shufersal_longitude
    icon: mdi:cart
    radius: 50    
    
####################################################
#                    Sensors                       #
####################################################
sensor:
  
#Sensor for Real State Home/Away to serve alexa to say welcome once
#Naty
  - platform: template
    sensors:
       naty_current_status:
         value_template: >-
            {% if is_state('device_tracker.mi_a1', 'home') or is_state('device_tracker.x', 'home') or  is_state('device_tracker.nl', 'home') %}
               Home
            {% elif is_state('device_tracker.nl', 'not_home') and ( is_state('device_tracker.mi_a1', 'not_home') or is_state('device_tracker.x', 'not_home') ) %}
               Away
            {% else %}
              {{ states.device_tracker.nl.state }}
            {% endif %}
         friendly_name: 'Naty Current Status'  
  #Nofar
  - platform: template
    sensors:
       nofar_current_status:
         value_template: >-
            {% if is_state('device_tracker.oneplus_5t', 'home') or is_state('device_tracker.x', 'home') or is_state('device_tracker.nc', 'home') %}
               Home
            {% elif is_state('device_tracker.nc', 'not_home') and ( is_state('device_tracker.oneplus_5t', 'not_home') or is_state('device_tracker.x', 'not_home') ) %}
               Away
            {% else %}
              {{ states.device_tracker.nc.state }}
            {% endif %}
         friendly_name: 'Nofar Current Status'  

####################################################
#                   Automations                    #
####################################################

automation:
#####################################################################
#                        Notification                               #
#####################################################################

###################
#       Naty      #
###################
- id: Naty is Home
  alias: Naty is Home
  trigger:
  - entity_id: sensor.naty_current_status
    platform: state
    to: 'home'
  condition:
  - condition: template
    value_template: "{{ states.sensor.nofar_current_status.state != 'home' }}"
  action:
  - data:
      title: '*Nofari, I''m glad to notice you that*'
      message: Naty has Arrived Home at {{ states('sensor.time') }}
    service: notify.telehome_nofar

- id: Naty leave Home
  alias: Naty leave Home
  trigger:
  - entity_id: sensor.naty_current_status
    platform: state
    from: 'home'
  condition:
  - condition: template
    value_template: "{{ states.sensor.nofar_current_status.state != 'home' }}"
  action:
  - data:
      title: '*Nofari, I would like to update you that*'
      message: Naty has Left Home at {{ states('sensor.time') }}
    service: notify.telehome_nofar
   
- id: Naty is at College
  alias: Naty is at College
  trigger:
  - entity_id: device_tracker.nl
    event: enter
    platform: zone
    zone: zone.college
  condition: []
  action:
  - data:
      message: Naty has arrived to College at {{ states('sensor.time') }}
      title: '*Nofari, I would like to update you that*'
    service: notify.telehome_nofar
   
- id: Naty leave College
  alias: Naty leave College
  trigger:
  - entity_id: device_tracker.nl
    event: leave
    platform: zone
    zone: zone.college
  condition: 
  - condition: state
    entity_id: device_tracker.nl
    state: 'Away'
    for:
      minutes: 10
  action:
  - data:
      title: '*Nofari, I would like to update you that*'
      message: Naty has Left College at {{ states('sensor.time') }}
    service: notify.telehome_nofar
    
- id: Naty arrived Ashkelon
  alias: Naty arrived Ashkelon
  trigger:
  - entity_id: device_tracker.nl
    event: enter
    platform: zone
    zone: zone.ashkelon
  condition:
  - condition: template
    value_template: "{{ states.sensor.naty_current_status.state == 'Ashkelon' and states.sensor.nofar_current_status.state != 'home' }}"
  action:
  - data:
      title: '*Nofari, I would like to update you that*'
      message: Naty has arived to Ashkelon at {{ states('sensor.time') }}
    service: notify.telehome_nofar 

####################
#       Nofar      #
####################

- id: Nofar is Home
  alias: Nofar is Home
  trigger:
  - entity_id: sensor.nofar_current_status
    platform: state
    to: 'home'
  condition:
  - condition: template
    value_template: "{{ states.sensor.naty_current_status.state != 'home' }}"
  action:
  - data:
      message: Nofar Arrived Home at {{ states('sensor.time') }}
    service: notify.telehome_naty

- id: Nofar left Home
  alias: Nofar left Home
  trigger:
  - entity_id: sensor.nofar_current_status
    platform: state
    from: 'home'
  condition:
  - condition: template
    value_template: "{{ states.sensor.naty_current_status.state != 'home' }}"
  action:
  - data:
      message: Nofar Left Home at {{ states('sensor.time') }}
    service: notify.telehome_naty

- id: Nofar_is at College
  alias: Nofar is at College
  trigger:
  - entity_id: device_tracker.nc
    event: enter
    platform: zone
    zone: zone.college
  condition: []
  action:
  - data:
      message: Nofar has arrived to College at {{ states('sensor.time') }}
    service: notify.telehome_naty
   
- id: Nofar leave College
  alias: Nofar leave College
  trigger:
  - entity_id: device_tracker.nc
    event: leave
    platform: zone
    zone: zone.college
  condition: 
  - condition: state
    entity_id: device_tracker.nc
    state: 'Away'
    for:
      minutes: 10
  action:
  - data:
      message: Nofar has Left College at {{ states('sensor.time') }}
    service: notify.telehome_naty
   
- id: Nofar is at Work
  alias: Nofar is at Work
  trigger:
  - entity_id: device_tracker.nc
    event: enter
    platform: zone
    zone: zone.nofar_work
  condition: []
  action:
  - data:
      message: Nofar has arrived to Work at {{ states('sensor.time') }}
    service: notify.telehome_naty
   
- id: Nofar left Work
  alias: Nofar left Work
  trigger:
  - entity_id: device_tracker.nc
    event: leave
    platform: zone
    zone: zone.nofar_work
  condition:
  - condition: state
    entity_id: device_tracker.nc
    state: 'Away'
    for:
      minutes: 20
  action:
  - data:
      message: Nofar has Left Work at {{ states('sensor.time') }}
    service: notify.telehome_naty
    
- id: Nofar arrived Natanya
  alias: Nofar arrived Natanya
  trigger:
  - entity_id: device_tracker.nc
    event: enter
    platform: zone
    zone: zone.natanya
  condition:
  - condition: template
    value_template: "{{ states.sensor.nofar_current_status.state == 'Natanya' and states.sensor.naty_current_status.state != 'home' }}"
  action:
  - data:
      message: Nofar has arived to Natanya at {{ states('sensor.time') }}
    service: notify.telehome_naty 
